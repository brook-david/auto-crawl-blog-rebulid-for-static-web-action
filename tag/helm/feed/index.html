<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Helm &#8211; DB`s Blog</title>
	<atom:link href="https://blog.wanderto.top/tag/helm/feed/" rel="self" type="application/rss+xml" />
	<link>https://blog.wanderto.top</link>
	<description>随心录</description>
	<lastBuildDate>Fri, 26 Apr 2024 09:28:25 +0000</lastBuildDate>
	<language>zh-CN</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=6.4.3</generator>

<image>
	<url>https://blog.wanderto.top/wp-content/uploads/2024/04/cropped-logo33-32x32.png</url>
	<title>Helm &#8211; DB`s Blog</title>
	<link>https://blog.wanderto.top</link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>建站记录</title>
		<link>https://blog.wanderto.top/2024/04/26/web-build-record/</link>
					<comments>https://blog.wanderto.top/2024/04/26/web-build-record/#respond</comments>
		
		<dc:creator><![CDATA[DB]]></dc:creator>
		<pubDate>Fri, 26 Apr 2024 08:57:13 +0000</pubDate>
				<category><![CDATA[运维]]></category>
		<category><![CDATA[Helm]]></category>
		<category><![CDATA[K8S]]></category>
		<category><![CDATA[OpenVPN]]></category>
		<guid isPermaLink="false">https://blog.wanderto.top/?p=1021</guid>

					<description><![CDATA[<p>前言 本篇文章聊聊本站的部署情况，我买的是阿里云的一年99￥的ECS，这样的配置有点太低了，所以我把自己的下岗 [&#8230;]</p>
<p>&lt;p&gt;The post <a rel="nofollow" href="https://blog.wanderto.top/2024/04/26/web-build-record/">建站记录</a> first appeared on <a rel="nofollow" href="https://blog.wanderto.top">DB`s Blog</a>.&lt;/p&gt;</p>
]]></description>
										<content:encoded><![CDATA[
<h2 class="wp-block-heading">前言</h2>



<pre class="wp-block-preformatted">本篇文章聊聊本站的部署情况，我买的是阿里云的一年99￥的ECS，这样的配置有点太低了，所以我把自己的下岗笔记本改成了一台服务器放在家里跑着，云服务器作为一个公网流量入口和集群控制平台，而本地的服务作为工作节点和数据存储位置。

<strong>集群配置</strong>：为了集群配置初始化方便快捷，我将K8s相关组件配置都用YAML文件存储了下来，将他们通过一定的组织形式写入到了init.sh脚本中。如果我需要重建集群，我可以直接运行这个脚本，立刻能够构建出与现在完全相同的集群环境。

<strong>网络环境</strong>：K8s的集群环境必需是内网，其间的Pod才能相互以IP进行通信，所以必需打通云服务与本地服务的网络。我用的是OpenVPN，服务端装在云服务器上，本地服务安装客户端主动连接VPN服务，并且服务端开启了OpenVPN的双向通信，服务端与客户端相互之间可以直接以对方局域网IP进行通信。

<strong>数据存储</strong>：为了让数据存储方便，我使用了K8s的OpenEBS插件将工作节点的磁盘做为存储位置，这样让我能更好的操作这些数据。<em>虽然存放在本地的文件比较安全，不过后续我可能会将这些<strong>数据</strong>定期<strong>上传到Github</strong>平台，以应对本地数据丢失的风险。另外本地服务器有可能会因为一些原因导致服务不可用（断网，断电），所以我打算把本站的相关页面以<strong>静态数据</strong>的形式下载并<strong>上传到Github</strong>平台，然后在Ingress中配置，如果服务不可用，就转而拉取这些静态数据返回，并且定期同步数据上去，这样如果因为意外情况，或者是临时不得不将本地服务停机也不会导致本站失联，后续完成后会修改并同步这部分内容。</em>
</pre>



<hr class="wp-block-separator has-alpha-channel-opacity"/>



<h2 class="wp-block-heading">集群配置</h2>



<pre class="wp-block-preformatted">为了能够更灵活的调整我的配置，我为每个模块都分配了init.sh脚本，以使它们能自由配置自己要初始化的内容，如下：</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">k8s
├── init.sh
├── config
│   └── kubeadm-init-config.conf
├── header_source.sh
├── readme
└── yaml
    ├── app
    │   └── wordpress
    │       ├── blog-web
    │       │   ├── ingress
    │       │   │   ├── backup
    │       │   │   │   ├── uncdn-wp-web-ingress.yaml
    │       │   │   │   └── wp-web-ingress.yaml
    │       │   │   ├── none-wp-web-ingress.yaml
    │       │   │   ├── uncdn-wp-web-ingress.yaml
    │       │   │   ├── wp-web-ingress.yaml
    │       │   │   └── www-wp-web-ingress.yaml
    │       │   ├── init.sh
    │       │   ├── secret
    │       │   │   ├── my-wordpress-mariadb.yaml
    │       │   │   └── my-wordpress.yaml
    │       │   ├── storage
    │       │   │   ├── 1-pv
    │       │   │   │   ├── data-my-wordpress-mariadb-0-pv.yaml
    │       │   │   │   └── my-wordpress-pv.yaml
    │       │   │   └── 2-pvc
    │       │   │       ├── data-my-wordpress-mariadb-0-pvc.yaml
    │       │   │       └── my-wordpress-pvc.yaml
    │       │   └── uninit.sh
    │       ├── init.sh
    │       ├── pic-web
    │       │   ├── ingress
    │       │   │   ├── backup
    │       │   │   │   ├── uncdn-wp-web-ingress.yaml
    │       │   │   │   └── wp-web-ingress.yaml
    │       │   │   └── wp-web-ingress.yaml
    │       │   ├── init.sh
    │       │   ├── secret
    │       │   │   ├── my-wordpress-mariadb.yaml
    │       │   │   └── my-wordpress.yaml
    │       │   ├── storage
    │       │   │   ├── 1-pv
    │       │   │   │   ├── data-my-wordpress-mariadb-0-pv.yaml
    │       │   │   │   └── my-wordpress-pv.yaml
    │       │   │   └── 2-pvc
    │       │   │       ├── data-my-wordpress-mariadb-0-pvc.yaml
    │       │   │       └── my-wordpress-pvc.yaml
    │       │   └── uninit.sh
    │       └── uninit.sh
    ├── init.sh
    ├── network
    │   ├── cert-manager
    │   │   ├── cert-manager.crds.yaml
    │   │   ├── cert-manager.custom.yaml
    │   │   ├── init.sh
    │   │   ├── ssl
    │   │   │   ├── letsencrypt-issuer-backup.yaml
    │   │   │   └── letsencrypt-issuer.yaml
    │   │   └── uninit.sh
    │   ├── ingress-controller
    │   │   ├── file
    │   │   │   ├── crds.yaml
    │   │   │   └── nginx-ingress-controller.yaml
    │   │   ├── init.sh
    │   │   ├── prepare
    │   │   └── uninit.sh
    │   ├── init.sh
    │   ├── kube-flannel.yaml
    │   └── uninit.sh
    ├── storage-class
    │   ├── init.sh
    │   ├── openEBS
    │   │   └── lite
    │   │       ├── openebs-lite-sc.yaml
    │   │       ├── openebs-operator-lite.yaml
    │   │       └── test-unuse
    │   │           ├── local-hostpath-pod.yaml
    │   │           └── test-pvc.yaml
    │   └── uninit.sh
    └── uninit.sh</pre>



<pre class="wp-block-preformatted">init.sh（main文件）内容如下：</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">. "$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&amp;1 &amp;&amp; _pwd=$(pwd) &amp;&amp; echo ${_pwd%%'/k8s'*})"/k8s/header_source.sh

echo '#== start init process ==#'
echo '#== init env ==#'
kubectl create namespace blog-web
kubectl create namespace picture-web
kubectl create namespace cert-manager

# init config
$_DIR/yaml/init.sh

echo '#== end init process ==#'</pre>



<pre class="wp-block-preformatted">集群初始化代码如下：</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">#启动集群
kubeadm init --config=k8s/config/kubeadm-init-config.conf

#初始化集群环境
./k8s/init.sh</pre>



<pre class="wp-block-preformatted">也许有人注意到了，初始化配置中并没有WordPress应用的部署。WordPress的pv/pvc和secret已经被我在初始化配置中提前创建。而WordPress直接用Helm来进行管理，如下：</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">#blog web
helm install my-wordpress bitnami/wordpress --version 19.4.3 -n blog-web
#scenery web
helm install my-wordpress bitnami/wordpress --version 19.4.3 -n picture-web</pre>



<hr class="wp-block-separator has-alpha-channel-opacity"/>



<h2 class="wp-block-heading">网络</h2>



<pre class="wp-block-preformatted">云服务与本地服务需要构建一个私有网络通道，我使用的是openvpn，安装参考：<a href="https://blog.csdn.net/shenql_/article/details/132266626" target="_blank" rel="noreferrer noopener nofollow">Linux系统搭建搭建OpenVPN</a>。

然后需要在服务端开启主动与客户端通信的能力，需要告诉openvpn服务器12.22.2.102<sup data-fn="5f30c3c0-3a90-483c-bab9-c3659cb45f20" class="fn"><a href="#5f30c3c0-3a90-483c-bab9-c3659cb45f20" id="5f30c3c0-3a90-483c-bab9-c3659cb45f20-link">1</a></sup>网络所在的位置，在ccd目录下创建一个客户端配置文件，然后在其中配置一个iroute来映射12.22.2.102的位置，如下：</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">[root@iZbp1605iwejf5qgem2c7hZ ~]# tree /etc/openvpn/
/etc/openvpn/
├── ccd
│   └── client
├── client
├── ipp.txt
├── openvpn-status.log
├── server
└── server.conf
[root@iZbp1605iwejf5qgem2c7hZ ~]# cat /etc/openvpn/ccd/client
iroute 12.22.2.0 255.255.255.0</pre>



<pre class="wp-block-preformatted">文档参考：<a href="https://community.openvpn.net/openvpn/wiki/RoutedLans" target="_blank" rel="noreferrer noopener nofollow">Lans behind OpenVPN</a></pre>



<hr class="wp-block-separator has-alpha-channel-opacity"/>



<h2 class="wp-block-heading">存储</h2>



<pre class="wp-block-preformatted">OpenEBS让集群能够自动生成绑定在本地机器上的PV/PVC的能力，不过它的策略是卸载后删除，如果误操作还是会丢失掉本地文件数据，所以在WordPress部署后将其PV/PVC复制一份下来存储到YAML文件中，并修改PV中的SC<sup data-fn="4959a241-a79f-4565-abe8-7fb1f838250d" class="fn"><a href="#4959a241-a79f-4565-abe8-7fb1f838250d" id="4959a241-a79f-4565-abe8-7fb1f838250d-link">2</a></sup>（storageClassName）与删除策略（persistentVolumeReclaimPolicy），如下：</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">apiVersion: v1
kind: PersistentVolume
metadata:
  name: pvc-2705f22b-f993-49d8-b82e-4a18804725b3
spec:
  accessModes:
  - ReadWriteOnce
  capacity:
    storage: 10Gi
  hostPath:
    path: /var/openebs/local/pvc-ee079675-34ad-49c7-b59e-1922d06ae731-blog-web
    type: DirectoryOrCreate # 或者使用 Directory，取决于你的需求
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - localhost.localdomain
  persistentVolumeReclaimPolicy: Retain
  storageClassName: wordpress-storage
  volumeMode: Filesystem</pre>



<hr class="wp-block-separator has-alpha-channel-opacity"/>


<ol class="wp-block-footnotes"><li id="5f30c3c0-3a90-483c-bab9-c3659cb45f20">这是一个客户端的局域网IP <a href="#5f30c3c0-3a90-483c-bab9-c3659cb45f20-link" aria-label="跳转到脚注引用 1"><img src="https://s.w.org/images/core/emoji/14.0.0/72x72/21a9.png" alt="↩" class="wp-smiley" style="height: 1em; max-height: 1em;" />︎</a></li><li id="4959a241-a79f-4565-abe8-7fb1f838250d">storageClassName可以随意命名，如果没有实际的SC那么它就相关一个命名空间的作用，hostPath会自动绑定对应的目录 <a href="#4959a241-a79f-4565-abe8-7fb1f838250d-link" aria-label="跳转到脚注引用 2"><img src="https://s.w.org/images/core/emoji/14.0.0/72x72/21a9.png" alt="↩" class="wp-smiley" style="height: 1em; max-height: 1em;" />︎</a></li></ol><p>&lt;p&gt;The post <a rel="nofollow" href="https://blog.wanderto.top/2024/04/26/web-build-record/">建站记录</a> first appeared on <a rel="nofollow" href="https://blog.wanderto.top">DB`s Blog</a>.&lt;/p&gt;</p>
]]></content:encoded>
					
					<wfw:commentRss>https://blog.wanderto.top/2024/04/26/web-build-record/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
	</channel>
</rss>
